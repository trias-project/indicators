---
title: "Taxonomic distribution emerging species"
author:
- Damiano Oldoni
- Tim Adriaens
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

This document follows the [ranking pipeline](https://trias-project.github.io/indicators/07_occurrence_indicators_modelling.html) to produce summary tables and graphs about the taxonomic distribution of the species defined as emerging (emerging status = 3).

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      tidy = 'styler')
```

Load libraries:

```{r load_libraries}
library(tidyverse) # To do data science
library(tidylog) # To provide feedback on dplyr functions
library(here) # To find files
```

# Get data

Read the tab separated files containing the emerging status output:

```{r read_ranking_emerging_status_hierarchical_strategy}
em_df <- readr::read_tsv(here::here(
  "data",
  "output", 
  "ranking_emerging_status_hierarchical_strategy.tsv"),
  na = ""
)
```

Preview:

```{r preview_em_df}
tidylog::slice_head(em_df, n = 10)
```

# Number of emerging species per class, year, location and variable

First, reshape the data:

```{r select_only_emerging_species}
emerging_df <-
  em_df %>%
  tidylog::pivot_longer(starts_with("year_"), 
               names_to = "variable",
               values_to = "emerging_status")
```

Preview:

```{r preview_emerging_df}
tidylog::slice_head(emerging_df, n = 10)
```

We calculate the number of emerging species (`emerging_status` = 3) 
at class level for each combination of:

- year
- variable: occupancy or number of observations
- area of interest: Belgium or protected areas

```{r n_emerging}
emerging_df <- 
  emerging_df %>%
  tidylog::group_by(.data$class, 
           .data$kingdom,
           .data$variable) %>%
  tidylog::summarise(n_emerging = length(.data$emerging_status[.data$emerging_status == 3]),
            n_total = length(.data$emerging_status))
```

Add year, variable and area of interest as columns:

```{r add_vars}
emerging_df <- 
  emerging_df %>%
  tidylog::mutate(
    year = stringr::str_extract(.data$variable, pattern = "\\d+"),
    area = stringr::str_extract(.data$variable, pattern = "BE$|pa$"),
    variable = stringr::str_extract(.data$variable,
                                    pattern = "occupancy|observations")) %>%
  tidylog::mutate(area = recode(.data$area, BE = "Belgium", pa = "Natura2000")) %>%
  tidylog::relocate(n_emerging, n_total, .after = last_col()) %>%
  tidylog::ungroup() %>%
  dplyr::arrange(.data$year, desc(.data$n_emerging))
```

Preview:

```{r preview_emergence_df}
head(emerging_df, 20)
```
Save this table as output file:

```{r save_emerging_df}
readr::write_tsv(
  emerging_df,
  here::here(
  "data",
  "output", 
  "number_of_emerging_taxa_per_class.tsv"),
  na = ""
)
```

# Summaries and graphs

Kingdoms with emerging species:

```{r kingdoms}
kingdoms <- emerging_df %>% tidylog::distinct(.data$kingdom)
kingdoms
```

Classes with emerging species:

```{r classes}
classes <- emerging_df %>% tidylog::distinct(.data$class, .data$kingdom)
classes
```
Distribution of classes at kingdom levels:

```{r classes_per_kingdom}
classes %>%
  tidylog::group_by(.data$kingdom) %>%
  tidylog::count() %>%
  dplyr::arrange(desc(.data$n))
```

## Taxonomic distribution at kingdom level

Number of emerging species at kingdom level:

```{r distr_at_kingdom_level}
emerging_df_kingdom <- 
  emerging_df %>%
  tidylog::group_by(.data$kingdom, .data$variable, .data$year, .data$area) %>%
  tidylog::summarise(n_emerging = sum(.data$n_emerging),
            n_total = sum(.data$n_total)) %>%
  tidylog::ungroup() %>%
  tidylog::mutate(frac_emerging = .data$n_emerging/.data$n_total) %>%
  dplyr::arrange(.data$variable, .data$area, .data$year, .data$kingdom)
emerging_df_kingdom
```

Show the absolute distribution at kingdom level for each variable/area/year:

```{r plot_kingdom_level_distr}
emerging_plot_kingdom <- 
  ggplot2::ggplot(emerging_df_kingdom) +
  ggplot2::geom_col(aes(x = kingdom, y = n_emerging, fill = year),
           position = "dodge") +
  ggplot2::facet_grid(rows = vars(variable), cols = vars(area))
emerging_plot_kingdom
```

Show the relative distribution, i.e. the fraction number of emerging species / total number of alien species:

```{r relative_distr_kingdom_level}
emerging_plot_kingdom_relative <- 
  ggplot2::ggplot(emerging_df_kingdom) +
  ggplot2::geom_col(aes(x = kingdom, y = frac_emerging, fill = year),
           position = "dodge") +
  ggplot2::facet_grid(rows = vars(variable), cols = vars(area))
emerging_plot_kingdom_relative
```

Save both the table `emerging_df_kingdom` and the graphs with the absolute and relative distribution of emerging species at kingdom level:

```{r save_emerging_df_kingdom}
# save data.frame
readr::write_tsv(x = emerging_df_kingdom,
                 file = here::here("data",
                                   "output",
                                   "taxonomic_distribution_emerging_species",
                                   "number_of_emerging_taxa_per_kingdom.tsv"
                                   ),
                 na = ""
)
# save plots with absolute distribution
ggplot2::ggsave(emerging_plot_kingdom,
                filename = here::here("data",
                                      "output",
                                      "taxonomic_distribution_emerging_species",
                                      "n_emerging_taxa_per_kingdom.png"
                                      )
)
# save plots with relative distribution
ggplot2::ggsave(emerging_plot_kingdom_relative,
                filename = here::here("data",
                                      "output",
                                      "taxonomic_distribution_emerging_species",
                                      "n_emerging_taxa_per_kingdom_relative.png"
                                      )
)
```

## Taxonomic distribution at class level

### Occupancy: Belgium

Table:

```{r emerging_df_BE_occupancy}
emerging_df_BE_occupancy <-
  emerging_df %>%
  tidylog::filter(.data$area == "Belgium" & .data$variable == "occupancy")
emerging_df_BE_occupancy
```

Graphs:

```{r plot_emerging_df_BE_occupancy}
emerging_plots_BE_occupancy <- purrr::map(kingdoms$kingdom, function(x) {
  data <- 
    emerging_df_BE_occupancy %>%
    tidylog::filter(.data$kingdom == x & .data$n_emerging > 0)
  ggplot2::ggplot(data) +
    ggplot2::geom_col(aes(x = class, y = n_emerging, fill = year), 
                      position = "dodge") +
    ggplot2::theme(
      axis.text.x = ggplot2::element_text(
        angle = 315,
        hjust = 0,
        vjust = 1
      )
    )
})
emerging_plots_BE_occupancy
```

Save both table and graphs:

```{r save_emerging_BE_occupancy}
readr::write_tsv(
  emerging_df_BE_occupancy,
  here::here(
  "data",
  "output",
  "taxonomic_distribution_emerging_species",
  "n_emerging_taxa_per_class_in_BE_occupancy.tsv"),
  na = ""
)
purrr::walk2(
  emerging_plots_BE_occupancy,
  kingdoms$kingdom, 
  function(x, y) {
    ggplot2::ggsave(here::here("data",
                      "output",
                      "taxonomic_distribution_emerging_species",
                      paste0("n_emerging_taxa_per_class_in_BE_occupancy_",
                             y,
                             ".png")),
           x)
})
```

### Occupancy: Natura2000

Table:

```{r emerging_df_Natura2000_occupancy}
emerging_df_Natura2000_occupancy <-
  emerging_df %>%
  tidylog::filter(.data$area == "Natura2000" & .data$variable == "occupancy")
emerging_df_Natura2000_occupancy
```

Graphs:

```{r plot_emerging_df_Natura2000_occupancy}
emerging_plots_Natura2000_occupancy <- purrr::map(
  kingdoms$kingdom, function(x) {
    data <- emerging_df_Natura2000_occupancy %>%
      tidylog::filter(.data$kingdom == x & .data$n_emerging > 0)
    ggplot2::ggplot(data) +
      ggplot2::geom_col(aes(x = class, y = n_emerging, fill = year), 
                        position = "dodge") +
      ggplot2::theme(
        axis.text.x = ggplot2::element_text(
          angle = 315,
          hjust = 0,
          vjust = 1
        )
      )
  })
emerging_plots_Natura2000_occupancy
```

Save both table and graphs:

```{r save_emerging_Natura2000_occupancy}
readr::write_tsv(
  emerging_df_Natura2000_occupancy,
  here::here(
  "data",
  "output",
  "taxonomic_distribution_emerging_species",
  "n_emerging_taxa_per_class_in_Natura2000_occupancy.tsv"),
  na = ""
)
purrr::walk2(
  emerging_plots_Natura2000_occupancy,
  kingdoms$kingdom, 
  function(x, y) {
    ggplot2::ggsave(here::here(
      "data",
      "output",
      "taxonomic_distribution_emerging_species",
      paste0("n_emerging_taxa_per_class_in_Natura2000_occupancy_",
             y,".png")
      ),
      x
    )
})
```


### Number of observations: Belgium

Table:

```{r emerging_df_BE_obs}
emerging_df_BE_obs <-
  emerging_df %>%
  tidylog::filter(.data$area == "Belgium" & .data$variable == "observations")
emerging_df_BE_obs
```

Graphs:

```{r emerging_plots_BE_obs}
emerging_plots_BE_obs <- purrr::map(kingdoms$kingdom, function(x) {
  data <- emerging_df_BE_obs %>%
    tidylog::filter(.data$kingdom == x & .data$n_emerging > 0)
  ggplot2::ggplot(data) +
    ggplot2::geom_col(aes(x = class, y = n_emerging, fill = year), 
                      position = "dodge") +
    ggplot2::theme(
    axis.text.x = ggplot2::element_text(
      angle = 315,
      hjust = 0,
      vjust = 1
      )
    )
})
emerging_plots_BE_obs
```

Save both table and graphs:

```{r save_emerging_BE_obs}
readr::write_tsv(
  emerging_df_BE_obs,
  here::here(
  "data",
  "output",
  "taxonomic_distribution_emerging_species",
  "n_emerging_taxa_per_class_in_BE_observations.tsv"),
  na = ""
)
purrr::walk2(
  emerging_plots_BE_obs,
  kingdoms$kingdom, 
  function(x, y) {
    ggplot2::ggsave(here::here(
      "data",
      "output",
      "taxonomic_distribution_emerging_species",
      paste0("n_emerging_taxa_per_class_in_BE_observations_",
             y,".png")
      ),
      x
    )
})
```


### Number of observations: Natura2000

Table:

```{r emerging_df_Natura2000_obs}
emerging_df_Natura2000_obs <-
  emerging_df %>%
  tidylog::filter(.data$area == "Natura2000" & .data$variable == "observations")
emerging_df_Natura2000_obs
```

Graphs:

```{r plot_emerging_df_Natura2000_obs}
emerging_plots_Natura2000_obs <- purrr::map(kingdoms$kingdom, function(x) {
  data <- emerging_df_Natura2000_obs %>%
    tidylog::filter(.data$kingdom == x & .data$n_emerging > 0)
  ggplot2::ggplot(data) +
    ggplot2::geom_col(aes(x = class, y = n_emerging, fill = year), 
                      position = "dodge") +
    ggplot2::theme(
    axis.text.x = ggplot2::element_text(
      angle = 315,
      hjust = 0,
      vjust = 1
      )
    )
})
emerging_plots_Natura2000_obs
```

Save both table and graphs:

```{r save_emerging_Natura2000_obs}
readr::write_tsv(
  emerging_df_Natura2000_obs,
  here::here(
  "data",
  "output",
  "taxonomic_distribution_emerging_species",
  "n_emerging_taxa_per_class_in_Natura2000_observations.tsv"),
  na = ""
)
purrr::walk2(
  emerging_plots_Natura2000_obs,
  kingdoms$kingdom, 
  function(x, y) {
    ggplot2::ggsave(here::here(
      "data",
      "output",
      "taxonomic_distribution_emerging_species",
      paste0("n_emerging_taxa_per_class_in_Natura2000_observations_",
             y,".png")
      ),
      x
    )
})
```
