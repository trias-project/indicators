---
title: "Indicator: Pathways associated with alien species introductions"
author:
- Damiano Oldoni
- Stijn Van Hoey
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

This document describes how to build indicators of Invasive Alien Species based on checklist data. In particular, this document takes into account:

1. pathways associated with alien species introductions (see GitHub isue [#19](https://github.com/trias-project/pipeline/issues/19))

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE)
```

Install `trias` package:

```{r install_packages, eval=FALSE}
devtools::install_github("trias-project/trias@add_functions_checklist_indicators")
```

Load libraries:

```{r load_libraries}
# Tidyverse packages
library(dplyr)
library(purrr)
library(stringr)
library(readr)
# project package
library(trias)
#other pckages
library(kableExtra)
library(here)
```

# Get data

```{r save_data_output}
data_file <- here("data", 
                  "interim",
                  "test_data_output_checklist_indicators.tsv")
data <- read_tsv(data_file)
```

# Build pathway indicator

## Find categories

We divide the species in categories. Each kingdom, except _Animalia_, is a category. If animal species are present, they are separated in two categories: vertebrates (phylum `Chordata`) and invertebrates (phylum other than `Chordata`, defined as `Not Chordata`).

```{r find_categories_in_data}
categories <- data %>% distinct(kingdom) %>%
  rename(category = kingdom)
if ("Animalia" %in% categories$category) {
  if ("Chordata" %in% data$phylum) {
    categories <- categories %>% 
      bind_rows(data.frame(category = "Chordata",
                           stringsAsFactors = FALSE))
  }
  if (data %>% 
      filter(kingdom == "Animalia") %>%
      filter(! phylum == "Chordata") %>%
      distinct(phylum) %>% nrow() > 0) {
    categories <- categories %>%
      bind_rows(data.frame(category = "Not Chordata",
                           stringsAsFactors = FALSE))
  }
  if (any(c("Chordata", "Not Chordata") %in% categories$category)) {
    categories <- categories %>%
      filter(category != "Animalia")
  }
}
```


## Pathways associated with alien species introductions

Function `get_table_pathways()` from `trias` library is used for creating a table based on checklist data, chosen species category and number of species returned as example per each pathway modality.
Number of species returned in table as examples of the group:

```{r set_n_species}
n_species <- 5
```

Pathways tables

```{r make_tables_all_data}
tables <- map(categories$category, ~ get_table_pathways(data, ., n_species))
names(tables) <- categories$category
```

## Pathways per category

Intentionality of introduction is mapped by cell color background: white for intentional introduction, grey for unintentional introduction.

### Plantae

Pathways for Plantae:

```{r view_tables, echo = FALSE, 'asis' = TRUE}
if ("Plantae" %in% categories$category) {
  kable(tables$Plantae) %>% 
    row_spec(which(tables$Plantae$pathway_level1 == "release"), 
           background = "white") %>%
    row_spec(which(tables$Plantae$pathway_level1 != "release"), 
           background = "#faf0e6") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "10cm")
}
```

### Vertebrates

Pathways for vertebrates:

```{r view_table_Chordata, echo = FALSE}
if ("Chordata" %in% categories$category) {
    kable(tables$Chordata) %>% 
    row_spec(which(tables$Chordata$pathway_level1 == "release"), 
           background = "white") %>%
    row_spec(which(tables$Chordata$pathway_level1 != "release"), 
           background = "#faf0e6") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "10cm")
}
```

### Invertebrates

Pathways for invertebrates:

```{r view_table_NotChordata, echo = FALSE}
if ("Not Chordata" %in% categories$category) {
  kable(tables$`Not Chordata`) %>% 
    row_spec(which(tables$`Not Chordata`$pathway_level1 == "release"), 
           background = "white") %>%
    row_spec(which(tables$`Not Chordata`$pathway_level1 != "release"), 
           background = "#faf0e6") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "10cm")
}
```

### Fungi

Pathways for Fungi:

```{r view_table_Fungi, echo = FALSE}
if ("Fungi" %in% categories$category) {
  kable(tables$Fungi) %>% 
    row_spec(which(tables$Fungi$pathway_level1 == "release"), 
           background = "white") %>%
    row_spec(which(tables$Fungi$pathway_level1 != "release"), 
           background = "#faf0e6") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "10cm")
}
```

### Bacteria

Pathways for Bacteria:

```{r view_table_Bacteria, echo = FALSE}
if ("Bacteria" %in% categories$category) {
  kable(tables$Bacteria) %>% 
    row_spec(which(tables$Bacteria$pathway_level1 == "release"), 
           background = "white") %>%
    row_spec(which(tables$Bacteria$pathway_level1 != "release"), 
           background = "#faf0e6") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "10cm")
}
```

Add sections for other kingdoms if needed.

## Pathways related to policy relevant species

It is important to focus our attention also to a intercategory group of species which is of particular policy importance.

We import this list of species:

```{r}
eu_concern_file <- here("data","input", "eu_concern_species.tsv")
eu_concern_species <- read_tsv(eu_concern_file)
```

Check which species form this subgroup are not present in `data`:

```{r check_presence_eu_species}
eu_concern_species %>% filter(!backbone_taxonKey %in% data$nubKey)
```

Present categories:

```{r categories_eu_concern}
categories_eu_concern <- data %>%
  filter(nubKey %in% eu_concern_species$backbone_taxonKey) %>%
  distinct(kingdom) %>%
  rename(category = kingdom)
if ("Animalia" %in% categories_eu_concern$category) {
  if ("Chordata" %in% data$phylum) {
    categories_eu_concern <- categories_eu_concern %>% 
      bind_rows(data.frame(category = "Chordata",
                           stringsAsFactors = FALSE))
  }
  if (data %>% 
      filter(kingdom == "Animalia") %>%
      filter(! phylum == "Chordata") %>%
      distinct(phylum) %>% nrow() > 0) {
    categories_eu_concern <- categories_eu_concern %>%
      bind_rows(data.frame(category = "Not Chordata",
                           stringsAsFactors = FALSE))
  }
  if (any(c("Chordata", "Not Chordata") %in% categories_eu_concern$category)) {
    categories_eu_concern <- categories_eu_concern %>%
      filter(category != "Animalia")
  }
}
```

Categories present in this subgroup:

```{r}
categories_eu_concern
```

Pathways tables:

```{r make_tables_eu_concern}
tables_eu_concern <- map(categories_eu_concern$category, ~ 
  get_table_pathways(data %>%
                       filter(nubKey %in% eu_concern_species$backbone_taxonKey), 
                     ., n_species))
names(tables_eu_concern) <- categories_eu_concern$category
```

### Plantae

```{r eu_concern_plantae}
if ("Plantae" %in% categories_eu_concern$category) {
  kable(tables_eu_concern$Plantae) %>% 
    row_spec(which(tables_eu_concern$Plantae$pathway_level1 == "release"), 
           background = "white") %>%
    row_spec(which(tables_eu_concern$Plantae$pathway_level1 != "release"), 
           background = "#faf0e6") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "10cm")
}
```

### Chordata

```{r eu_concern_chordata}
if ("Chordata" %in% categories_eu_concern$category) {
  kable(tables_eu_concern$Chordata) %>% 
    row_spec(which(tables_eu_concern$Plantae$pathway_level1 == "release"), 
           background = "white") %>%
    row_spec(which(tables_eu_concern$Chordata$pathway_level1 != "release"), 
           background = "#faf0e6") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "10cm")
}
```

### Not Chordata

```{r eu_concern_not_chordata}
if ("`Not Chordata`" %in% categories_eu_concern$category) {
  kable(tables_eu_concern$`Not Chordata`) %>% 
    row_spec(which(tables_eu_concern$`Not Chordata`$pathway_level1 == "release"), 
           background = "white") %>%
    row_spec(which(tables_eu_concern$`Not Chordata`$pathway_level1 != "release"), 
           background = "#faf0e6") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "10cm")
}
```
