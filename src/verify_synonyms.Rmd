---
title: "Verify synonyms"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: flatly
    df_print: kable
knit: (function(input_file, encoding) { rmarkdown::render(input_file, encoding = encoding, output_file = paste0("../docs/",sub(".Rmd", ".html", basename(input_file))))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set locale (so we use UTF-8 character encoding):

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r}
# Tidyverse packages
library(dplyr)
library(magrittr)
library(purrr)
library(readr)

# Other packages
library(RCurl)
# library(lazyeval)
library(rgbif)
library(trias)
```

## Load data

Set file paths. For supporting versioning, it is reccomended to use always the raw version of a permalink:

```{r}
input_checklist_taxa <- "https://raw.githubusercontent.com/trias-project/pipeline/967de37326425fb55446dc573c9e6e01451d857e/data/output/checklist_taxa.tsv"
input_verified_taxa <- "https://raw.githubusercontent.com/trias-project/pipeline/verify_synonyms_pipeline/data/output/verified_synonims.tsv"
```

Load taxa in a df from file:

```{r}
checklist_taxa <- read_delim(file = getURL(input_checklist_taxa), 
                             delim = "\t", escape_double = FALSE, 
                             trim_ws = TRUE)
```

Preview:

```{r}
# backbone_taxonKey
# checklist_taxonKey
# checklist_scientificName
# checklist_datasetKey
# backbone_scientificName
# backbone_kingdom
# backbone_taxonomicStatus
# backbone_acceptedKey
# backbone_accepted
head(checklist_taxa)
```

Load verified synonyms:

```{r}
# use text = getURL(input_verified_taxa) after local testing
verified_synonyms <- read_delim("../data/output/verified_synonims.tsv", delim = "\t", escape_double = FALSE, trim_ws = TRUE)
```

Preview:

```{r}
# columns:
# backbone_taxonKey
# backbone_scientificName
# backbone_accepted
# backbone_acceptedKey
# backbone_kingdom
# date_added
# verified_key
# remarks
head(verified_synonyms)
```

## Find new synonym combinations

Select taxa where `backbone_acceptedKey` is not `NA`:

```{r}
checklist_taxa %>% filter(!is.na(backbone_acceptedKey)) -> backbone_synonyms
```

Number of taxa with synonym in backbone:

```{r}
nrow(backbone_synonyms)
```

Preview:

```{r}
head(backbone_synonyms)
```

For every `backbone_taxonKey` - `backbone_acceptedKey` combination, where `backbone_acceptedKey` is not NA, update verified synonyms:

```{r}
# For every backbone_taxonKey, backbone_acceptedKey -> check in file
# If in file:
# If backbone_scientificName + backbone_accepted different -> store in updated_names + update

verified_synonyms %>% 
  inner_join(backbone_synonyms, 
         by = c("backbone_taxonKey", "backbone_acceptedKey")) %>% 
  filter(backbone_scientificName.x != backbone_scientificName.y | 
           backbone_accepted.x != backbone_accepted.y) %>% 
  select(backbone_scientificName.x, backbone_scientificName.y,
         backbone_accepted.x, backbone_accepted.y) %>% 
  rename(backbone_scientificName = backbone_scientificName.x,
         new_backbone_scientificName = backbone_scientificName.y,
         backbone_accepted = backbone_accepted.x,
         new_backbone_accepted = backbone_accepted.y) -> updated_names

changes <- updated_names %>% 
  left_join(verified_synonyms,
            by = c("backbone_scientificName", "backbone_accepted")) %>%
  select(-c(backbone_scientificName, backbone_accepted)) %>%
  rename(backbone_scientificName = new_backbone_scientificName,
         backbone_accepted = new_backbone_accepted)

verified_synonyms <- verified_synonyms %>% 
  filter(backbone_taxonKey != changes$backbone_taxonKey) %>%
  union(changes)

# If same -> do nothing

# If not in file -> add new line + store in new_synonyms

backbone_synonyms %>% 
  filter(!(backbone_taxonKey %in% verified_synonyms$backbone_taxonKey) |
           !(backbone_acceptedKey %in% verified_synonyms$backbone_acceptedKey)) -> new_synonyms


# If in synonyms file but not in input taxa -> store in unused_synonyms

```

## Results

These names have been updated (but synonym relation stayed the same):

```{r}
updated_names
```

These synonym relations are no longer used:

```{r}
# unused_synonyms
```

These synonym relations were added and should be verified:

```{r}
# new_synonyms
```

## Update taxa

Add `verified_key`

```{r}
# add column verified_key (is empty)
```

Accept all ACCEPTED and DOUBTFUL:

```{r}
# for backbone_taxonomicStatus = ACCEPTED or DOUBTFUL
# verified_key = backbone_taxonKey
```

Update taxa with verified synonyms info:

```{r}
# for taxonomicStatus = SYNONYM
# Look up backbone_nubKey + backbone_acceptedKey in verified_synonyms
# populate verified_key
```

Shows some stats:

```{r}
# Number of accepted taxa
# Number of doubtful taxa
# Number of verified synonyms
# Number of unverified synonyms
```

```{r}
# save to tsv -> checklist_taxa_verified
```
